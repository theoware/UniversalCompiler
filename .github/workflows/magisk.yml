name: Magisk Build

on:
  push:
    paths: .github/workflows/magisk.yml

  workflow_dispatch:
    inputs: 
      ref:
        description: 'Ref to checkout'
        required: falses

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NDK_CCACHE: ${{ github.workspace }}/ccache
      CCACHE_DIR: ${{ github.workspace }}/.ccache

    steps:

    - name: Check out
      uses: actions/checkout@v3.0.2
      with:
        submodules: 'recursive'
        fetch-depth: 0
        repository: vvb2060/Magisk
        ref: ${{ inputs.tags }} 

    - name: set up JDK 11
      uses: actions/setup-java@v3.3.0
      with:
        java-version: 11
        distribution: temurin

    - name: Set up Python 3
      uses: actions/setup-python@v4.0.0
      with:
        python-version: '3.x'

    - name: Set up ccache
      run: bash .github/ccache.sh

    - name: Cache Gradle dependencies
      uses: actions/cache@v3.0.4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          !~/.gradle/caches/build-cache-*
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle.kts') }}
        restore-keys: ${{ runner.os }}-gradle-

    - name: Cache build cache
      uses: actions/cache@v3.0.4
      with:
        path: |
          ${{ github.workspace }}/.ccache
          ~/.gradle/caches/build-cache-*
        key: ${{ runner.os }}-build-cache-${{ github.sha }}
        restore-keys: ${{ runner.os }}-build-cache-

    - name: Set up NDK
      run: python build.py -v ndk

    - name: Build release
      run: |
        ./ccache -zp
        echo 'org.gradle.jvmargs=-Xmx3096m' >> gradle.properties
        python build.py -vr all

    - name: Build debug
      run: |
        python build.py -v all
        ./ccache -s

    - name: Stop gradle daemon
      run: ./gradlew --stop

    - name: Unzip files
      run: |
        mkdir -p out/app-debug
        mkdir -p out/stub-release
        mkdir -p out/app-release
        unzip out/app-debug.apk -d out/app-debug
        unzip out/stub-release.apk -d out/stub-release
        unzip out/app-release.apk -d out/app-release

    - name: Upload release build artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        name: ${{ github.sha }}_app-release
        path: out/app-release

    - name: Upload stub-release build artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        name: ${{ github.sha }}_stub-release
        path: out/stub-release

    - name: Upload debug build artifact
      uses: actions/upload-artifact@v3.1.0
      with:
        name: ${{ github.sha }}_app-debug
        path: out/app-debug